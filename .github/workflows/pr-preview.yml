name: PR Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        
    - run: npm ci
    - run: make build
    - run: make dist
    
    - name: Add noindex to preview
      run: |
        # Add noindex meta tags to prevent search engine indexing
        sed -i 's|<meta charset="utf-8" />|<meta charset="utf-8" />\n\t<meta name="robots" content="noindex, nofollow, noarchive, nosnippet" />\n\t<meta http-equiv="X-Robots-Tag" content="noindex, nofollow" />|' dist/index.html
        
        # Create robots.txt to disallow all crawlers for previews
        cat > dist/robots.txt << 'EOF'
        User-agent: *
        Disallow: /
        EOF
    
    - name: Deploy to gh-pages branch
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Create/checkout gh-pages branch
        git fetch origin gh-pages || git checkout --orphan gh-pages
        git checkout gh-pages || git checkout --orphan gh-pages
        
        # Create PR directory and copy files
        mkdir -p pr-${{ github.event.number }}
        cp -r dist/* pr-${{ github.event.number }}/
        
        # Commit and push
        git add pr-${{ github.event.number }}
        git commit -m "Deploy PR #${{ github.event.number }} preview" || exit 0
        git push origin gh-pages
        
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const deployUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${prNumber}/`;
          
          const comment = `ðŸš€ **Preview deployed!**
          
          ðŸ“– Preview URL: ${deployUrl}
          ðŸ”— [Visit preview â†’](${deployUrl})
          
          This preview will be updated automatically when you push new commits.`;
          
          // Find existing comment to update
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });
          
          const existingComment = comments.find(
            comment => comment.body.includes('ðŸš€ **Preview deployed!**')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
          }
          
  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v4
      with:
        ref: gh-pages
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Remove PR preview
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -d "pr-${{ github.event.number }}" ]; then
          rm -rf pr-${{ github.event.number }}
          git add .
          git commit -m "Remove PR #${{ github.event.number }} preview" || exit 0
          git push origin gh-pages
        fi